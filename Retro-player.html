<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Crap-turon 5000 LoFi Player - Enhanced Cassette</title>
    <style>
        body { background: #1a1a1a; margin: 0; font-family: 'Arial Narrow', Arial, sans-serif; }
        .hifi-container { max-width: 900px; margin: 30px auto; padding: 25px; background: linear-gradient(145deg, #2b2b2b, #404040); border: 4px solid #555; border-radius: 12px; box-shadow: inset 0 0 15px rgba(0,0,0,0.9), 0 4px 20px rgba(0,0,0,0.7); color:#d0d0d0; transition: filter 0.3s; position: relative }
        .hifi-container.off { filter: brightness(0.5); pointer-events: none; }
        .hifi-container.off .power-button { pointer-events: auto; }
        .section { border:3px solid #666; padding:20px; margin-bottom:15px; background: linear-gradient(180deg,#3a3a3a,#2e2e2e); border-radius:8px; box-shadow: inset 0 2px 8px rgba(0,0,0,0.8), 0 2px 5px rgba(0,0,0,0.5); }
        .power-volume { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
        .power-button { background: linear-gradient(145deg,#5a5a5a,#383838); border:2px solid #777; border-radius:6px; padding:12px 24px; color:#fff; font-size:18px; font-weight:bold; text-shadow:0 1px 3px rgba(0,0,0,0.6); cursor:pointer; box-shadow: 0 3px 6px rgba(0,0,0,0.5), inset 0 1px 2px rgba(255,255,255,0.2); transition: box-shadow 0.1s ease-in-out; }
        .power-button.on { box-shadow: inset 0 3px 6px rgba(0,0,0,0.8), inset 0 1px 2px rgba(255,255,255,0.1); }
        .power-button:hover { background: linear-gradient(145deg,#6a6a6a,#484848); }
        .power-led { width:10px; height:10px; background:#333; border:1px solid #666; border-radius:50%; margin-top:10px; box-shadow: inset 0 0 3px rgba(0,0,0,0.8); transition: box-shadow 0.3s, background-color 0.3s; }
        .power-led.on { background-color:#44ff44; box-shadow: 0 0 10px #44ff44, inset 0 0 5px #44ff44; }
        .volume-control { flex-grow:1; text-align:center; position:relative; }
        .volume-label { font-size:16px; text-transform:uppercase; margin-bottom:8px; color:#b0b0b0; text-shadow:0 1px 2px rgba(0,0,0,0.5); }
        .knob-container { position:relative; width:150px; height:150px; margin:0 auto; }
        canvas.knob { width:100%; height:100%; cursor:pointer; display:block; }
        .volume-display { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:24px; font-weight:bold; color:#fff; text-shadow:0 0 5px #ff4444; pointer-events:none; }
        .knob-scale { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:170px; height:170px; border-radius:50%; pointer-events:none; }
        .brand-name { font-family:'Courier New', monospace; font-size:24px; font-weight:bold; color:#44ff44; text-shadow:0 0 5px rgba(68,255,68,0.7); letter-spacing:2px; position: absolute; top: 0; right: 0; }
        .cd-panel { background:#1e1e1e; padding:15px; border-radius:6px; margin:15px 0; box-shadow: inset 0 0 8px rgba(0,0,0,0.9); border:2px solid #555; justify-content: center; }
        .cd-panel input[type="file"] { display:none; }
        .button-effect { background: linear-gradient(145deg,#5a5a5a,#383838); border:2px solid #777; color:#fff; padding:10px 20px; border-radius:6px; cursor:pointer; font-weight:bold; font-size:16px; text-shadow:0 1px 2px rgba(0,0,0,0.6); box-shadow: 0 3px 6px rgba(0,0,0,0.5), inset 0 1px 2px rgba(255,255,255,0.2); transition: box-shadow 0.1s; width:95%; display:block; text-align:left; }
        .button-effect.on { box-shadow: inset 0 3px 6px rgba(0,0,0,0.8), inset 0 1px 2px rgba(255,255,255,0.1); }
        .button-effect:hover { background: linear-gradient(145deg,#6a6a6a,#484848); }
        .track-info { margin:15px 0; padding:8px; background:#0a2a0a; color:#00ff00; font-family:'Courier New', monospace; border:2px solid #444; border-radius:4px; box-shadow: inset 0 0 5px rgba(0,255,0,0.3); }
        .track-time { margin:10px 0; padding:8px; background:#0a2a0a; color:#00ff00; font-family:'Courier New', monospace; border:2px solid #444; border-radius:4px; box-shadow: inset 0 0 5px rgba(0,255,0,0.3); }
        .transport-controls button { background: linear-gradient(145deg,#5a5a5a,#383838); border:2px solid #777; color:#fff; padding:10px 20px; margin:8px; border-radius:6px; cursor:pointer; font-weight:bold; font-size:16px; text-shadow:0 1px 2px rgba(0,0,0,0.6); box-shadow:0 3px 6px rgba(0,0,0,0.5); }
        .transport-controls button:disabled { background: linear-gradient(145deg,#333,#222); color:#666; cursor:not-allowed; box-shadow:none; }
        .transport-controls button:hover:not(:disabled) { background: linear-gradient(145deg,#6a6a6a,#484848); }
		.station-list { background-color: grey; color: white; }
		.fm-radio-box select { width: 97%; }
        .equalizer { display:flex; justify-content:space-between; align-items:center; height:140px; background:#252525; padding:20px; border-radius:6px; border:2px solid #555; box-shadow: inset 0 0 8px rgba(0,0,0,0.8); }
        .eq-band { display:flex; flex-direction:column; align-items:center; width:9%; text-align:center; position:relative; }
        .loudness-band { display:flex; flex-direction:column; align-items:center; width:9%; text-align:center; position:relative; margin-left: auto; }
        .eq-band label { font-size:20px; color:#b0b0b0; text-shadow:0 1px 2px rgba(0,0,0,0.5); margin-bottom:1px; }
        .loudness-band label { font-size:20px; color:#b0b0b0; text-shadow:0 1px 2px rgba(0,0,0,0.5); margin-bottom:1px; }
        .gain-label { position:absolute; font-size:10px; color:#888; font-family:'Courier New', monospace; user-select:none; }
        .gain-label.plus { top:25px; right:15px; }
        .gain-label.minus { bottom:1px; right:15px; }
        .eq-band input { -webkit-appearance: slider-vertical; width:20px; height:100px; background: linear-gradient(#555,#333); border:1px solid #777; border-radius:4px; box-shadow: inset 0 0 4px rgba(0,0,0,0.5); }
        .loudness-band input { -webkit-appearance: slider-vertical; width:20px; height:100px; background: linear-gradient(#555,#333); border:1px solid #777; border-radius:4px; box-shadow: inset 0 0 4px rgba(0,0,0,0.5); }
        .spectrum-analyzer { height:120px; background:#1e1e1e; position:relative; border:3px solid #555; border-radius:6px; box-shadow: inset 0 0 8px rgba(0,0,0,0.9); }
        canvas.spectrum-canvas { width:100%; height:100%; display:block; }
		.station-list { background-color: grey; color: white; }
		#radioStation { background-color: #808080; color: white; border: 2px solid #777; border-radius: 6px; padding: 10px; font-weight: bold;       text-shadow: 0 1px 2px rgba(0, 0, 0, 0.6);box-shadow: 0 3px 6px rgba(0, 0, 0, 0.5), inset 0 1px 2px rgba(255, 255, 255, 0.2); }
        #radioStation option { background-color: #808080; color: white; }
        .stereo-effect { display:flex; justify-content:space-around; align-items:center; flex-wrap: wrap; gap: 10px; }
        .playlist { font-size:16px; color:#00ff00; font-family:'Courier New', monospace; background:#0a2a0a; padding:10px; border:2px solid #444; border-radius:4px; box-shadow: inset 0 0 5px rgba(0,255,0,0.3); max-height:150px; overflow-y:auto; }
        .playlist-item { padding:8px; cursor:pointer; border-radius:4px; }
        .playlist-item:hover { background:#1a3a1a; }
        .playlist-item.active { background:#2a4a2a; font-weight:bold; }
        .error-message { color:#ff4444; text-align:center; padding:10px; font-family:'Courier New', monospace; display:none; }
		.fm-radio-box { width: 250px; }

        /* Cassette Quality Settings */
        .cassette-controls { background:#2a2a2a; padding:15px; margin-top:10px; border:2px solid #555; border-radius:6px; }
        .cassette-controls h4 { color:#ffaa44; margin:0 0 10px 0; }
        .quality-selector { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
        .quality-btn { background:#444; border:1px solid #666; color:#ccc; padding:5px 10px; border-radius:4px; cursor:pointer; font-size:12px; }
        .quality-btn.active { background:#664422; color:#ffaa44; border-color:#aa8844; }
    </style>
</head>
<body>
    <div class="hifi-container" id="hifiContainer">
        <div class="section power-volume">
            <div style="display:flex; flex-direction:column; align-items:center;">
                <button class="power-button" id="powerButton">POWER OFF</button>
                <div class="power-led" id="powerLed"></div>
            </div>
            <div class="volume-control">
                <div class="volume-label">VOLUME</div>
                <div class="knob-container">
                    <canvas id="volumeKnob" class="knob"></canvas>
                    <span class="volume-display">50</span>
                    <div class="knob-scale"></div>
                </div>
            </div>
            <div class="brand-name">Crap-turon 5000</div>
        </div>

        <div class="section cd-transport">
            <div class="cd-panel">
                <label for="mp3Input" class="button-effect" id="loadCdButton">LOAD A CD</label>
                <input type="file" id="mp3Input" accept="audio/mp3" multiple>
            </div>
            <div class="track-info" id="trackInfo" style="text-align: center;">No track loaded</div>
            <div class="track-time" id="trackTime" style="text-align: center;">0:00 / 0:00</div>
            <div class="transport-controls" style="text-align: center;">
                <button id="prevButton">⏮</button>
                <button id="playButton">▶ PLAY</button>
                <button id="nextButton">⏭</button>
            </div>
        </div>

        <div class="section cd-transport">
            <div class="cd-panel" style="text-align: center;">
                <label for="radioStation" class="button-effect">FM RADIO</label>
                <select id="radioStation" class="button-effect"><option value="">Loading stations...</option></select>
            </div>
        </div>

        <div class="section equalizer">
            <div class="eq-band">
                <label>31Hz</label>
                <input type="range" min="-12" max="12" value="0" class="eq-slider" data-freq="31">
                <span class="gain-label plus">+10</span>
                <span class="gain-label minus">-10</span>
            </div>
            <div class="eq-band">
                <label>62Hz</label>
                <input type="range" min="-12" max="12" value="0" class="eq-slider" data-freq="62">
                <span class="gain-label plus">+10</span>
                <span class="gain-label minus">-10</span>
            </div>
            <div class="eq-band">
                <label>125Hz</label>
                <input type="range" min="-12" max="12" value="0" class="eq-slider" data-freq="125">
                <span class="gain-label plus">+10</span>
                <span class="gain-label minus">-10</span>
            </div>
            <div class="eq-band">
                <label>250Hz</label>
                <input type="range" min="-12" max="12" value="0" class="eq-slider" data-freq="250">
                <span class="gain-label plus">+10</span>
                <span class="gain-label minus">-10</span>
            </div>
            <div class="eq-band">
                <label>500Hz</label>
                <input type="range" min="-12" max="12" value="0" class="eq-slider" data-freq="500">
                <span class="gain-label plus">+10</span>
                <span class="gain-label minus">-10</span>
            </div>
            <div class="eq-band">
                <label>1kHz</label>
                <input type="range" min="-12" max="12" value="0" class="eq-slider" data-freq="1000">
                <span class="gain-label plus">+10</span>
                <span class="gain-label minus">-10</span>
            </div>
            <div class="eq-band">
                <label>2kHz</label>
                <input type="range" min="-12" max="12" value="0" class="eq-slider" data-freq="2000">
                <span class="gain-label plus">+10</span>
                <span class="gain-label minus">-10</span>
            </div>
            <div class="eq-band">
                <label>4kHz</label>
                <input type="range" min="-12" max="12" value="0" class="eq-slider" data-freq="4000">
                <span class="gain-label plus">+10</span>
                <span class="gain-label minus">-10</span>
            </div>
            <div class="eq-band">
                <label>8kHz</label>
                <input type="range" min="-12" max="12" value="0" class="eq-slider" data-freq="8000">
                <span class="gain-label plus">+10</span>
                <span class="gain-label minus">-10</span>
            </div>
            <div class="eq-band">
                <label>12kHz</label>
                <input type="range" min="-12" max="12" value="0" class="eq-slider" data-freq="12000">
                <span class="gain-label plus">+10</span>
                <span class="gain-label minus">-10</span>
            </div>
        </div>

        <div class="section spectrum-analyzer">
            <canvas id="spectrumCanvas" class="spectrum-canvas"></canvas>
            <div id="errorMessage" class="error-message">Failed to load audio. Please check file or permissions.</div>
        </div>

        <div class="section stereo-effect">
            <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: space-around; width: 100%;">
                <button class="button-effect" id="binatoneButton">Crap Bass Boost: OFF</button>
                <button class="button-effect" id="hyperbassButton">Hyper Bass: OFF</button>
                <button class="button-effect" id="cassetteButton">Cassette Mode: OFF</button>
                <button class="button-effect" id="stereoWideButton">Stereo Wide: OFF</button>
                <button class="button-effect" id="speedButton">Speed: Normal</button>
                <button class="button-effect" id="loudnessButton">Loudness: OFF</button>
                <button class="button-effect" id="warpDriveButton">High Speed Dubbing: OFF</button>
            </div>

            <div class="cassette-controls" id="cassetteControls" style="display:none; width:100%;">
                <h4>Cassette Quality Settings</h4>
                <div class="quality-selector">
                    <span style="color:#ccc; margin-right:10px;">Tape Quality:</span>
                    <button class="quality-btn active" data-quality="normal">Normal</button>
                    <button class="quality-btn" data-quality="worn">Worn</button>
                    <button class="quality-btn" data-quality="damaged">Damaged</button>
                    <button class="quality-btn" data-quality="vintage">Vintage</button>
					<button class="quality-btn" data-quality="chewedUp">Chewed Up Tape</button>
                </div>
            </div>
        </div>

        <div class="section playlist">
            <div>PLAYLIST</div>
            <div id="playlistContainer"></div>
        </div>
    </div>

    <script>
        // ============================================
        // Global Variables
        // ============================================

        // Power Button Elements
        const powerButton = document.getElementById('powerButton');
        const powerLed = document.getElementById('powerLed');
        const hifiContainer = document.getElementById('hifiContainer');
        const errorMessage = document.getElementById('errorMessage');
        let isPoweredOn = false;

        // Volume Knob Elements
        const knobCanvas = document.getElementById('volumeKnob');
        const knobCtx = knobCanvas.getContext('2d');
        const volumeDisplay = document.querySelector('.volume-display');
        let isDragging = false;
        let lastAngle = 0;
        let volume = 50;

        // Audio Elements
        const mp3Input = document.getElementById('mp3Input');
        const playButton = document.getElementById('playButton');
        const prevButton = document.getElementById('prevButton');
        const nextButton = document.getElementById('nextButton');
        const trackInfo = document.getElementById('trackInfo');
        const trackTime = document.getElementById('trackTime');
        const playlistContainer = document.getElementById('playlistContainer');
        const loadCdButton = document.getElementById('loadCdButton');
        const binatoneButton = document.getElementById('binatoneButton');
        const hyperbassButton = document.getElementById('hyperbassButton');
        const cassetteButton = document.getElementById('cassetteButton');
        const stereoWideButton = document.getElementById('stereoWideButton');
        const speedButton = document.getElementById('speedButton');
        const loudnessButton = document.getElementById('loudnessButton');
        const eqSliders = document.querySelectorAll('.eq-slider');
        const cassetteControls = document.getElementById('cassetteControls');
        const warpDriveButton = document.getElementById('warpDriveButton');

        // Radio Element
        const radioStation = document.getElementById('radioStation');

        // Audio Context Variables
        let audioCtx, analyser, audioElement, source, eqFilters, lowpass, highpass, bassBoost, noiseSource, noiseGainNode, stereoPanner, loudnessGainNode, masterGain;

        // Playlist Variables
        let playlist = [];
        let currentTrackIndex = -1;
        let pressTimer, seekInterval;

        // Spectrum Analyzer Elements
        const spectrumCanvas = document.getElementById('spectrumCanvas');
        const spectrumCtx = spectrumCanvas.getContext('2d');

        // Enhanced Cassette Variables
        let cassetteQuality = 'normal';
        let wowFlutterOscillator, wowFlutterGain, delayNode;
        let noiseSourceLow, noiseGainLow, noiseSourceMid, noiseGainMid;
        let compressionNode, compressionGain;
        let cassetteFilterLow, cassetteFilterHigh;
        let wowFlutterAnimationId = null;

        // Speed settings
        const speeds = [{ label: 'Normal', rate: 1.0 }, { label: '33rpm', rate: 0.55 }, { label: '45rpm', rate: 0.75 }, { label: '78rpm', rate: 1.3 }];
        let currentSpeedIndex = 0;
        let speedRampInterval = null;

        // Enhanced Cassette Quality Presets
        const cassettePresets = {
            normal: {
                wowFlutterAmount: 0.003,
                wowFlutterSpeed: 0.5,
                hissLevel: 0.001,
                compressionRatio: 0.95,
                lowCut: 60,
                highCut: 12000,
                distortionLevel: 0
            },
            worn: {
                wowFlutterAmount: 0.02,
                wowFlutterSpeed: 0.3,
                hissLevel: 0.003,
                compressionRatio: 0.85,
                lowCut: 80,
                highCut: 8000,
                distortionLevel: 0.1
            },
            damaged: {
                wowFlutterAmount: 0.19,
                wowFlutterSpeed: 0.6,
                hissLevel: 0.009,
                compressionRatio: 0.7,
                lowCut: 120,
                highCut: 4000,
                distortionLevel: 0.3
            },
            vintage: {
                wowFlutterAmount: 0.015,
                wowFlutterSpeed: 0.1,
                hissLevel: 0.006,
                compressionRatio: 0.6,
                lowCut: 100,
                highCut: 6000,
                distortionLevel: 0.2
            },
			chewedUp: {
				wowFlutterAmount: 0.19,
				wowFlutterSpeed: 0.6,
				hissLevel: 0.009,
				compressionRatio: 0.7,
				lowCut: 120,
				highCut: 4000,
				distortionLevel: 0.3
			}
        };

        // ============================================
        // Enhanced Cassette Effect Functions
        // ============================================

        function createCassetteEffectChain() {
            if (!audioCtx) return;

            // Create wow & flutter using multiple oscillators for realism
            wowFlutterOscillator = audioCtx.createOscillator();
            wowFlutterOscillator.type = 'sine';
            wowFlutterOscillator.frequency.value = 0.1;
            
            wowFlutterGain = audioCtx.createGain();
            wowFlutterGain.gain.value = 0.003;
            
            wowFlutterOscillator.connect(wowFlutterGain);
            wowFlutterOscillator.start();

            // Create multiple noise sources for realistic tape hiss
            // High frequency hiss
            const hissBuffer = audioCtx.createBuffer(1, audioCtx.sampleRate, audioCtx.sampleRate);
            const hissData = hissBuffer.getChannelData(0);
            for (let i = 0; i < audioCtx.sampleRate; i++) {
                hissData[i] = (Math.random() * 2 - 1) * 0.5;
            }

            noiseSourceLow = audioCtx.createBufferSource();
            noiseSourceLow.buffer = hissBuffer;
            noiseSourceLow.loop = true;
            noiseSourceLow.start();

            noiseGainLow = audioCtx.createGain();
            noiseGainLow.gain.value = 0;

            // Mid-frequency noise for more realistic hiss
            const midHissBuffer = audioCtx.createBuffer(1, audioCtx.sampleRate, audioCtx.sampleRate);
            const midHissData = midHissBuffer.getChannelData(0);
            for (let i = 0; i < audioCtx.sampleRate; i++) {
                // More filtered noise for mid frequencies
                midHissData[i] = (Math.random() * 2 - 1) * Math.sin(i * 0.001) * 0.3;
            }

            noiseSourceMid = audioCtx.createBufferSource();
            noiseSourceMid.buffer = midHissBuffer;
            noiseSourceMid.loop = true;
            noiseSourceMid.start();

            noiseGainMid = audioCtx.createGain();
            noiseGainMid.gain.value = 0;

            // Compression for tape saturation effect
            compressionNode = audioCtx.createDynamicsCompressor();
            compressionNode.threshold.value = -15;
            compressionNode.knee.value = 8;
            compressionNode.ratio.value = 4;
            compressionNode.attack.value = 0.003;
            compressionNode.release.value = 0.25;

            compressionGain = audioCtx.createGain();
            compressionGain.gain.value = 1;

            // Cassette-specific frequency response
            cassetteFilterLow = audioCtx.createBiquadFilter();
            cassetteFilterLow.type = 'highpass';
            cassetteFilterLow.frequency.value = 60;
            cassetteFilterLow.Q.value = 0.7;

            cassetteFilterHigh = audioCtx.createBiquadFilter();
            cassetteFilterHigh.type = 'lowpass';
            cassetteFilterHigh.frequency.value = 12000;
            cassetteFilterHigh.Q.value = 0.7;

            // Connect noise sources to analyser
            noiseSourceLow.connect(noiseGainLow);
            noiseSourceMid.connect(noiseGainMid);

            noiseGainLow.connect(analyser);
            noiseGainMid.connect(analyser);
        }

        function applyCassetteQuality(quality) {
            const preset = cassettePresets[quality];
            if (!preset || !audioCtx) return;

            // Update wow & flutter
            if (wowFlutterOscillator && wowFlutterGain) {
                wowFlutterOscillator.frequency.value = preset.wowFlutterSpeed;
                wowFlutterGain.gain.value = preset.wowFlutterAmount;
            }

            // Update noise levels
            if (noiseGainLow) noiseGainLow.gain.value = preset.hissLevel;
            if (noiseGainMid) noiseGainMid.gain.value = preset.hissLevel * 0.6;

            // Update frequency response
            if (cassetteFilterLow) cassetteFilterLow.frequency.value = preset.lowCut;
            if (cassetteFilterHigh) cassetteFilterHigh.frequency.value = preset.highCut;

            // Update compression for saturation
            if (compressionNode && compressionGain) {
                compressionGain.gain.value = preset.compressionRatio;
                compressionNode.threshold.value = -15 + (preset.distortionLevel * 10);
            }

            cassetteQuality = quality;
        }
        
        // This is the updated, corrected function
        function startEnhancedWowFlutter() {
            if (wowFlutterAnimationId) {
                cancelAnimationFrame(wowFlutterAnimationId);
            }

            let dropoutScheduled = false;

            function updateWowFlutter() {
                if (audioElement && cassetteButton.classList.contains('on') && audioCtx) {
                    const preset = cassettePresets[cassetteQuality];
                    const time = audioCtx.currentTime;

                    // Standard wow & flutter effect
                    const mainWow = Math.sin(time * 2 * Math.PI * 0.1) * preset.wowFlutterAmount;
                    const flutter = Math.sin(time * 2 * Math.PI * 0.8) * (preset.wowFlutterAmount * 0.3);
                    const randomFlutter = (Math.random() - 0.5) * preset.wowFlutterAmount * 0.1;
                    const totalFlutter = mainWow + flutter + randomFlutter;

                    // Apply the pitch change
                    audioElement.playbackRate = Math.max(0.1, speeds[currentSpeedIndex].rate + totalFlutter);

                    // === Chewed Up effect logic ===
                    if (cassetteQuality === 'chewedUp') {
                        // Schedule a dropout every 40 seconds
                        if (!dropoutScheduled) {
                            const dropoutTime = time + 40; // Schedule 40 seconds from now
                            const preDropoutTime = dropoutTime - 0.5; // 0.5 seconds before dropout
                            
                            // Schedule bandwidth narrowing
                            cassetteFilterHigh.frequency.setValueAtTime(800, preDropoutTime);
                            cassetteFilterLow.frequency.setValueAtTime(400, preDropoutTime);

                            // Schedule volume drop
                            masterGain.gain.setValueAtTime(0.2, dropoutTime);
                            
                            // Schedule a pitch change during the dropout
                            audioElement.playbackRate = Math.max(0.1, speeds[currentSpeedIndex].rate - 0.2);

                            // Schedule recovery of bandwidth, pitch, and volume
                            masterGain.gain.setValueAtTime(1, dropoutTime + 1); // Recover in 1 second
                            cassetteFilterHigh.frequency.setValueAtTime(preset.highCut, dropoutTime + 1.1);
                            cassetteFilterLow.frequency.setValueAtTime(preset.lowCut, dropoutTime + 1.1);
                            
                            dropoutScheduled = true;
                            
                            // Reset dropoutScheduled flag after the event has passed
                            setTimeout(() => {
                                dropoutScheduled = false;
                            }, (dropoutTime + 2 - time) * 1000);
                        }
                    } else {
                        // Reset to normal values if not 'chewedUp'
                        masterGain.gain.cancelScheduledValues(audioCtx.currentTime);
                        masterGain.gain.setValueAtTime(1, audioCtx.currentTime);
                        cassetteFilterHigh.frequency.cancelScheduledValues(audioCtx.currentTime);
                        cassetteFilterHigh.frequency.setValueAtTime(preset.highCut, audioCtx.currentTime);
                        cassetteFilterLow.frequency.cancelScheduledValues(audioCtx.currentTime);
                        cassetteFilterLow.frequency.setValueAtTime(preset.lowCut, audioCtx.currentTime);
                        dropoutScheduled = false;
                    }

                } else if (audioElement) {
                    // Ensure playback rate is normal when cassette mode is off
                    audioElement.playbackRate = speeds[currentSpeedIndex].rate;
                }

                wowFlutterAnimationId = requestAnimationFrame(updateWowFlutter);
            }

            updateWowFlutter();
        }

        function stopEnhancedWowFlutter() {
            if (wowFlutterAnimationId) {
                cancelAnimationFrame(wowFlutterAnimationId);
                wowFlutterAnimationId = null;
            }
        }

        // ============================================
        // LocalStorage Functions
        // ============================================

        function saveSettings() {
            try {
                const settings = {
                    volume: volume,
                    hyperBassOn: hyperbassButton.classList.contains('on'),
                    equalizer: Array.from(eqSliders).map(slider => parseFloat(slider.value)),
                    loudnessOn: loudnessButton.classList.contains('on'),
                    cassetteQuality: cassetteQuality
                };
                localStorage.setItem('crapTuronSettings', JSON.stringify(settings));
            } catch (e) {
                console.error('Failed to save settings to localStorage:', e);
            }
        }

        function loadSettings() {
            try {
                const savedSettings = localStorage.getItem('crapTuronSettings');
                if (savedSettings) {
                    const settings = JSON.parse(savedSettings);

                    // Restore volume
                    volume = settings.volume || 50;
                    drawKnob();
                    if (audioElement) {
                        audioElement.volume = volume / 100;
                    }

                    // Restore Hyper Bass
                    if (settings.hyperBassOn) {
                        hyperbassButton.classList.add('on');
                        hyperbassButton.textContent = 'Hyper Bass: ON';
                        if (bassBoost) {
                            bassBoost.gain.value = 5;
                        }
                    }

                    // Restore Equalizer bands
                    const frequencies = [31, 62, 125, 250, 500, 1000, 2000, 4000, 8000, 12000];
                    if (settings.equalizer && settings.equalizer.length === frequencies.length) {
                        eqSliders.forEach((slider, index) => {
                            const gainValue = settings.equalizer[index];
                            slider.value = gainValue;
                            if (eqFilters && eqFilters[index]) {
                                eqFilters[index].gain.value = gainValue;
                            }
                        });
                    }

                    // Restore Loudness
                    if (settings.loudnessOn) {
                        loudnessButton.classList.add('on');
                        loudnessButton.textContent = 'Loudness: ON';
                        if (loudnessGainNode) {
                            loudnessGainNode.gain.value = 1.2;
                        }
                    }

                    // Restore Cassette Quality
                    if (settings.cassetteQuality) {
                        cassetteQuality = settings.cassetteQuality;
                        updateQualityButtons();
                    }
                }
            } catch (e) {
                console.warn('Failed to load settings from localStorage. Using defaults.', e);
            }
        }

        function updateQualityButtons() {
            document.querySelectorAll('.quality-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.quality === cassetteQuality);
            });
        }

        // ============================================
        // Full Radio Station List
        // ============================================
          const radioStations = [
            // Hip Hop & R&B Stations
            {"name":"The Beat (181.fm, Hip Hop/R&B)","url":"http://listen.181fm.com/181-beat_128k.mp3"},
            {"name":"Underground 80s (SomaFM)","url":"https://ice5.somafm.com/u80s-128-mp3"},
            {"name":"Hot 108 Jamz (New York, Hip Hop)","url":"https://stream.hot108.com:8000/hot108"},
            {"name":"100 Hip Hop and RNB FM (181.fm)","url":"http://listen.181fm.com/181-100hhrnb_128k.mp3"},
            {"name":"Streetz 108 (Hip Hop)","url":"http://listen.181fm.com/181-streetz_128k.mp3"},
            {"name":"The Box (181.fm, Hip Hop/R&B)","url":"http://listen.181fm.com/181-box_128k.mp3"},
            {"name":"DEFJAY (Berlin, Hip Hop/R&B)","url":"http://listen.defjay.de:8000/rnb.mp3"},
            {"name":"bigFM Oldschool Rap & Hip-Hop","url":"https://stream.bigfm.de/oldschool-rap"},
            {"name":"GotRadio - Hip Hop Stop","url":"http://playerservices.streamtheworld.com/api/livestream-redirect/GOTRADIO_HIPHOP_STOP.mp3"},
            {"name":"HipHop/RNB - HitsRadio","url":"http://icecast.radio.net/stream/hitsradio_hiphop.mp3"},
            {"name":"Black Beats (Germany, Hip Hop/R&B)","url":"http://stream.blackbeats.fm:8000/blackbeats"},
            {"name":"True R'n'B (181.fm)","url":"http://listen.181fm.com/181-truernb_128k.mp3"},
            
            // 80s & Retro Stations
            {"name":"70s Hits (181.fm)","url":"http://listen.181fm.com/181-70s_128k.mp3"},
            {"name":"Oldies (181.fm)","url":"http://listen.181fm.com/181-oldies_128k.mp3"},
            {"name":"Awesome 80s (181.fm)","url":"http://listen.181fm.com/181-awesome80_128k.mp3"},
            {"name":"80s Hits - HitsRadio","url":"http://icecast.radio.net/stream/hitsradio_80s.mp3"},
            {"name":"80s80s Rock (radio.net)","url":"http://icecast.radio.net/stream/80s80s_rock.mp3"},
            {"name":"80s Dance Hits (HitsRadio)","url":"http://icecast.radio.net/stream/hitsradio_80sdance.mp3"},
            {"name":"Big 80s Station (181.fm)","url":"http://listen.181fm.com/181-big80s_128k.mp3"},
            {"name":"90s Hits (181.fm)","url":"http://listen.181fm.com/181-90s_128k.mp3"},
            
            // Rock & Alternative
            {"name":"Rock 181 (181.fm)","url":"http://listen.181fm.com/181-rock_128k.mp3"},
            {"name":"Classic Rock (181.fm)","url":"http://listen.181fm.com/181-classicrock_128k.mp3"},
            {"name":"Alternative Rock (181.fm)","url":"http://listen.181fm.com/181-altrock_128k.mp3"},
            {"name":"Hard Rock Heaven (181.fm)","url":"http://listen.181fm.com/181-hardrock_128k.mp3"},
            {"name":"Punk Rock (181.fm)","url":"http://listen.181fm.com/181-punk_128k.mp3"},
            {"name":"Grunge (181.fm)","url":"http://listen.181fm.com/181-grunge_128k.mp3"},
            
            // Electronic & Dance
            {"name":"Power 181 (Dance/Electronic)","url":"http://listen.181fm.com/181-power_128k.mp3"},
            {"name":"Club 181 (House/Techno)","url":"http://listen.181fm.com/181-club_128k.mp3"},
            {"name":"Energy 98 (181.fm, Trance)","url":"http://listen.181fm.com/181-energy98_128k.mp3"},
            {"name":"Techno 181","url":"http://listen.181fm.com/181-techno_128k.mp3"},
            {"name":"The Buzz (Alternative Rock)","url":"http://listen.181fm.com/181-buzz_128k.mp3"},
            {"name":"90s Dance (181.fm)","url":"http://listen.181fm.com/181-90sdance_128k.mp3"},
                        
            // Top 40 & Pop
            {"name":"Hot Hits USA (181.fm)","url":"http://listen.181fm.com/181-hothitsusa_128k.mp3"},
            {"name":"Top 40 (181.fm)","url":"http://listen.181fm.com/181-top40_128k.mp3"},
            {"name":"The Hits (181.fm)","url":"http://listen.181fm.com/181-hits_128k.mp3"},
            {"name":"Star 90s (181.fm)","url":"http://listen.181fm.com/181-star90s_128k.mp3"},
            {"name":"Laser Hot Hits","url":"http://213.175.217.198:8000/laserhq"},
            
            // Country & Folk
            {"name":"Kickin' Country (181.fm)","url":"http://listen.181fm.com/181-kickincountry_128k.mp3"},
            {"name":"Real Country (181.fm)","url":"http://listen.181fm.com/181-realcountry_128k.mp3"},
            {"name":"Good Time Oldies (181.fm)","url":"http://listen.181fm.com/181-goodtime_128k.mp3"},
            
            // Jazz & Blues
            {"name":"Real Jazz (181.fm)","url":"http://listen.181fm.com/181-jazz_128k.mp3"},
            {"name":"Smooth Jazz (181.fm)","url":"http://listen.181fm.com/181-smoothjazz_128k.mp3"},
            {"name":"The Blues (181.fm)","url":"http://listen.181fm.com/181-blues_128k.mp3"},
            {"name":"Linn Jazz","url":"http://radio.linn.co.uk:8000/autodj"},
            {"name":"Naim Jazz [320k AAC]","url":"https://mscp3.live-streams.nl:8342/jazz-high.aac"},
            
            // Classical
            {"name":"Classical 181","url":"http://listen.181fm.com/181-classical_128k.mp3"},
            {"name":"Linn Classical","url":"http://radio.linn.co.uk:8004/autodj"},
            {"name":"Naim Classical [320k AAC]","url":"https://mscp3.live-streams.nl:8252/class-high.aac"},
            
            // Reggae & World
            {"name":"Joint Radio Reggae","url":"http://star.jointil.net/proxy/jrn_reggae?mp=/stream"},
            {"name":"Reggae 141 (181.fm)","url":"http://listen.181fm.com/181-reggae_128k.mp3"},
            {"name":"Radio Alfa 3 Latin Hits","url":"http://stream.zeno.fm/pexep60uhnruv"},
            
            // Chillout & Ambient
            {"name":"Chilled (181.fm)","url":"http://listen.181fm.com/181-chilled_128k.mp3"},
            {"name":"Ambient (181.fm)","url":"http://listen.181fm.com/181-ambient_128k.mp3"},
            {"name":"Radio Paradise (320k)","url":"http://stream-uk1.radioparadise.com/aac-320"},
            {"name":"Deep House Lounge","url":"http://198.15.94.34:8006/stream"},
            {"name":"Naim Radio [320k AAC]","url":"https://mscp3.live-streams.nl:8362/high.aac"},
            {"name":"Linn Radio","url":"http://radio.linn.co.uk:8003/autodj"},
            
            // Additional 181.fm Stations
            {"name":"Studio 181 (Eclectic)","url":"http://listen.181fm.com/181-studio_128k.mp3"},
            {"name":"Vocal Jazz (181.fm)","url":"http://listen.181fm.com/181-vocaljazz_128k.mp3"},
            {"name":"Soft Hits (181.fm)","url":"http://listen.181fm.com/181-softhits_128k.mp3"},
            {"name":"Urban Jamz (181.fm)","url":"http://listen.181fm.com/181-urbanjamz_128k.mp3"},
            {"name":"Christmas 181 (Seasonal)","url":"http://listen.181fm.com/181-christmas_128k.mp3"},
            {"name":"Halloween 181 (Seasonal)","url":"http://listen.181fm.com/181-halloween_128k.mp3"},
            
            // SomaFM Network (High Quality Alternative)
            {"name":"SomaFM Beat Blender","url":"https://ice4.somafm.com/beatblender-128-mp3"},
            {"name":"SomaFM Deep Space One","url":"https://ice4.somafm.com/deepspaceone-128-mp3"},
            {"name":"SomaFM Drone Zone","url":"https://ice4.somafm.com/dronezone-128-mp3"},
            {"name":"SomaFM Fluid","url":"https://ice4.somafm.com/fluid-128-mp3"},
            {"name":"SomaFM Indie Pop Rocks!","url":"https://ice4.somafm.com/indiepop-128-mp3"},
            {"name":"SomaFM Groove Salad","url":"https://ice4.somafm.com/groovesalad-128-mp3"},
            {"name":"SomaFM Lush","url":"https://ice4.somafm.com/lush-128-mp3"},
            {"name":"SomaFM Left Coast 70s","url":"https://ice4.somafm.com/seventies-128-mp3"},
            {"name":"SomaFM PopTron","url":"https://ice4.somafm.com/poptron-128-mp3"},
            {"name":"SomaFM Suburbs of Goa","url":"https://ice4.somafm.com/suburbsofgoa-128-mp3"},
            {"name":"SomaFM ThistleRadio","url":"https://ice4.somafm.com/thistleradio-128-mp3"},
            
            // Talk & News
            {"name":"The Breeze (181.fm)","url":"http://listen.181fm.com/181-breeze_128k.mp3"},
            {"name":"Smooth AC (181.fm)","url":"http://listen.181fm.com/181-smoothac_128k.mp3"},
            
            // Specialty & Experimental
            {"name":"Angel Radio","url":"http://s2.xrad.io:8522/listen.pls?sid=1"},
            {"name":"181.fm The Point","url":"http://listen.181fm.com/181-thepoint_128k.mp3"},
            {"name":"181.fm The Mix","url":"http://listen.181fm.com/181-themix_128k.mp3"},
            
            // International & World Music
            {"name":"Radio Caroline","url":"http://sc6.radiocaroline.net:8040/stream.mp3"},
            {"name":"Radio Caroline Flashback","url":"http://sc2.radiocaroline.net:10558/listen.pls"},
            {"name":"Radio Northsea International","url":"http://radionorthsea.zapto.org:8008/listen.pls"},
            {"name":"Radio Seagull","url":"http://stream.radioseagull.net:8000/seagull"},
            {"name":"Danubius Rádió","url":"http://stream.danubiusradio.hu/danubius_128k"},
            {"name":"Radio Osttirol","url":"http://streamplus20.leonex.de:28768/;"}
        ];

        // ============================================
        // Helper: stop and disconnect existing source
        // ============================================
        function stopCurrentSource() {
            try {
                if (audioElement) {
                    audioElement.pause();
                    try { audioElement.src = ""; } catch (e) {}
                    audioElement = null;
                }
            } catch (e) {
                console.warn('Error stopping audioElement:', e);
            }
            try {
                if (source) {
                    try { source.disconnect(); } catch (e) {}
                    source = null;
                }
            } catch (e) {
                console.warn('Error disconnecting source:', e);
            }
        }

        // ============================================
        // Check station availability
        // ============================================
        async function checkStations() {
            radioStation.innerHTML = '<option value="">Scanning for live stations...</option>';
            const availableStations = [];

            for (const station of radioStations) {
                try {
                    const testAudio = new Audio();
                    testAudio.src = station.url;
                    testAudio.crossOrigin = 'anonymous';

                    await new Promise((resolve, reject) => {
                        let fired = false;
                        function cleanup() {
                            testAudio.removeEventListener('loadedmetadata', onLoad);
                            testAudio.removeEventListener('error', onError);
                        }
                        function onLoad() { if (!fired) { fired = true; cleanup(); resolve(); } }
                        function onError() { if (!fired) { fired = true; cleanup(); reject(); } }
                        testAudio.addEventListener('loadedmetadata', onLoad, { once: true });
                        testAudio.addEventListener('error', onError, { once: true });
                        setTimeout(() => { if (!fired) { fired = true; cleanup(); reject(); } }, 3000);
                    });

                    availableStations.push(station);
                } catch (e) {
                    console.warn('Station failed or timed out:', station.name);
                }
            }

            radioStation.innerHTML = '';
            const defaultOpt = document.createElement('option');
            defaultOpt.value = '';
            defaultOpt.textContent = availableStations.length ? 'Select a station...' : 'No stations available';
            radioStation.appendChild(defaultOpt);

            if (availableStations.length > 0) {
                availableStations.forEach(station => {
                    const opt = document.createElement('option');
                    opt.value = station.url;
                    opt.textContent = station.name;
                    radioStation.appendChild(opt);
                });
            }
        }

        // ============================================
        // Play a web radio stream
        // ============================================
        function playStream(url, displayName) {
            if (!isPoweredOn) {
                errorMessage.style.display = 'block';
                errorMessage.textContent = 'Please press the POWER button first.';
                radioStation.selectedIndex = 0;
                return;
            }

            if (!audioCtx) {
                initAudioContext();
            }
            stopCurrentSource();

            audioElement = new Audio(url);
            audioElement.crossOrigin = "anonymous";
            audioElement.volume = volume / 100;
            audioElement.playbackRate = speeds[currentSpeedIndex].rate;
            trackInfo.textContent = displayName || 'Radio Stream';

            audioElement.addEventListener('error', (ev) => {
                console.error('Radio stream error for', url, ev);
                errorMessage.style.display = 'block';
                errorMessage.textContent = 'Failed to load radio stream.';
            });

            audioElement.addEventListener('canplay', () => {
                try {
                    source = audioCtx.createMediaElementSource(audioElement);
                } catch (e) {
                    console.error('createMediaElementSource failed:', e);
                    errorMessage.style.display = 'block';
                    errorMessage.textContent = 'Browser does not allow connecting media element to AudioContext.';
                    return;
                }

                if (!eqFilters) initAudioContext();
                connectAudioChain();

                if (audioCtx.state === 'suspended') {
                    audioCtx.resume().then(() => {
                        audioElement.play().catch(err => console.error('Play error after resume:', err));
                    }).catch(err => console.error('Resume error:', err));
                } else {
                    audioElement.play().catch(err => console.error('Play error:', err));
                }

                playButton.textContent = '⏸⏸ PAUSE';
            });
        }

        radioStation.addEventListener('change', (e) => {
            const url = e.target.value;
            const name = e.target.options[e.target.selectedIndex] ? e.target.options[e.target.selectedIndex].text : '';
            if (!url) return;
            playStream(url, name);
        });

        // ============================================
        // Audio Chain Connection
        // ============================================
        function connectAudioChain() {
            if (!source || !eqFilters || !masterGain) return;

            // Main audio path
            source.connect(eqFilters[0]);
            eqFilters[eqFilters.length - 1].connect(loudnessGainNode);
            loudnessGainNode.connect(bassBoost);
            bassBoost.connect(lowpass);
            lowpass.connect(highpass);
            highpass.connect(stereoPanner);

            // Enhanced cassette chain (if active)
            if (cassetteButton.classList.contains('on') && cassetteFilterLow && cassetteFilterHigh && compressionNode) {
                // Disconnect old chain and insert cassette processing
                highpass.disconnect();
                highpass.connect(cassetteFilterLow);
                cassetteFilterLow.connect(cassetteFilterHigh);
                cassetteFilterHigh.connect(compressionNode);
                compressionNode.connect(compressionGain);
                compressionGain.connect(stereoPanner);
            }

            // Connect to analyser and final gain
            stereoPanner.connect(analyser);
            analyser.connect(masterGain);
            masterGain.connect(audioCtx.destination);

            // Connect noise sources to analyser
            if (noiseGainLow) noiseGainLow.connect(analyser);
            if (noiseGainMid) noiseGainMid.connect(analyser);
        }

        // ============================================
        // Power Button Functionality
        // ============================================
        powerButton.addEventListener('click', () => {
            isPoweredOn = !isPoweredOn;
            hifiContainer.classList.toggle('off', !isPoweredOn);
            powerButton.textContent = isPoweredOn ? 'POWER ON' : 'POWER OFF';
            powerButton.classList.toggle('on', isPoweredOn);
            powerLed.classList.toggle('on', isPoweredOn);

            if (isPoweredOn) {
                if (audioCtx && audioCtx.state === 'suspended') {
                    audioCtx.resume().catch(err => {
                        console.error('Error resuming AudioContext:', err);
                        errorMessage.style.display = 'block';
                        errorMessage.textContent = 'Please interact with the page to enable audio.';
                    });
                }
                trackInfo.textContent = 'Crap-turon 5000 - Turning good sound to shit since 1988';
                setTimeout(() => {
                    trackInfo.textContent = 'No track loaded';
                    if (playlist.length > 0 && currentTrackIndex >= 0) {
                        trackInfo.textContent = playlist[currentTrackIndex].name;
                    }
                }, 5000);

                if (!audioCtx) {
                    initAudioContext();
                }
            } else {
                if (audioCtx) {
                    audioCtx.suspend().catch(err => { console.error('Error suspending AudioContext:', err); });
                }
                stopEnhancedWowFlutter();

                trackInfo.textContent = 'Crap-turon 5000 turning off';
                setTimeout(() => { trackInfo.textContent = 'No track loaded'; }, 2000);

                if (audioElement) {
                    audioElement.pause();
                    playButton.textContent = '▶ PLAY';
                    trackTime.textContent = '0:00 / 0:00';
                    if (source) source.disconnect();
                    audioElement = null;
                    source = null;
                }
            }
            errorMessage.style.display = 'none';
        });

        // ============================================
        // Volume Knob Functions (same as original)
        // ============================================
        function drawKnob() {
            const centerX = knobCanvas.width / 2;
            const centerY = knobCanvas.height / 2;
            const radius = knobCanvas.width / 2 - 10;
            const startAngle = (Math.PI / 180) * -140;
            const endAngle = (Math.PI / 180) * 130;
            const totalAngle = endAngle - startAngle;
            const angle = startAngle + (totalAngle * (volume / 100));

            knobCtx.clearRect(0, 0, knobCanvas.width, knobCanvas.height);

            knobCtx.beginPath();
            knobCtx.arc(centerX, centerY, radius, 0, 2 * Math.PI, false);
            knobCtx.fillStyle = '#111';
            knobCtx.fill();

            knobCtx.beginPath();
            knobCtx.arc(centerX, centerY, radius, startAngle, angle, false);
            knobCtx.strokeStyle = '#ff4444';
            knobCtx.lineWidth = 10;
            knobCtx.stroke();

            knobCtx.beginPath();
            knobCtx.arc(centerX, centerY, radius - 15, 0, 2 * Math.PI, false);
            knobCtx.fillStyle = '#333';
            knobCtx.fill();
            knobCtx.strokeStyle = '#555';
            knobCtx.lineWidth = 2;
            knobCtx.stroke();

            const indicatorLength = radius - 15;
            const indicatorX = centerX + indicatorLength * Math.cos(angle);
            const indicatorY = centerY + indicatorLength * Math.sin(angle);
            knobCtx.beginPath();
            knobCtx.moveTo(centerX, centerY);
            knobCtx.lineTo(indicatorX, indicatorY);
            knobCtx.strokeStyle = '#ff4444';
            knobCtx.lineWidth = 5;
            knobCtx.stroke();

            volumeDisplay.textContent = Math.round(volume);
        }

        function handleKnobInteraction(event) {
            if (!isPoweredOn) return;
            const rect = knobCanvas.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            const angle = Math.atan2(event.clientY - centerY, event.clientX - centerX);
            let volumeAngle = angle * (180 / Math.PI);
            const startLimit = -140;
            const endLimit = 130;

            if (volumeAngle < startLimit) { volumeAngle = startLimit; } else if (volumeAngle > endLimit) { volumeAngle = endLimit; }

            volume = (volumeAngle - startLimit) * 100 / (endLimit - startLimit);

            if (audioElement) { try { audioElement.volume = volume / 100; } catch (e) {} }

            drawKnob();
            saveSettings();
        }

        knobCanvas.addEventListener('mousedown', (event) => { if (!isPoweredOn) return; isDragging = true; handleKnobInteraction(event); });
        document.addEventListener('mousemove', (event) => { if (isDragging) handleKnobInteraction(event); });
        document.addEventListener('mouseup', () => { isDragging = false; });

        // ============================================
        // Audio Context Initialization
        // ============================================
        function initAudioContext() {
            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                
                // Initialize master gain control
                masterGain = audioCtx.createGain();

                // Initialize analyzer
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 256;
                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                drawSpectrum(dataArray, bufferLength);

                // Create EQ filters
                const frequencies = [31,62,125,250,500,1000,2000,4000,8000,12000];
                eqFilters = frequencies.map(freq => {
                    const filter = audioCtx.createBiquadFilter();
                    filter.type = 'peaking';
                    filter.frequency.value = freq;
                    filter.Q.value = 1.4;
                    filter.gain.value = 0;
                    return filter;
                });

                // Connect EQ filters in series
                for (let i=0;i<eqFilters.length-1;i++) {
                    eqFilters[i].connect(eqFilters[i+1]);
                }

                // Other filters
                lowpass = audioCtx.createBiquadFilter(); 
                lowpass.type = 'lowpass'; 
                lowpass.frequency.value = 20000; 
                lowpass.Q.value = 1;
                
                highpass = audioCtx.createBiquadFilter(); 
                highpass.type = 'highpass'; 
                highpass.frequency.value = 20; 
                highpass.Q.value = 1;
                
                bassBoost = audioCtx.createBiquadFilter(); 
                bassBoost.type = 'lowshelf'; 
                bassBoost.frequency.value = 40; 
                bassBoost.gain.value = 0;
                
                loudnessGainNode = audioCtx.createGain(); 
                loudnessGainNode.gain.value = 1;

                // Old noise (keeping for compatibility)
                const bufferSize = audioCtx.sampleRate;
                const noiseBuffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
                const output = noiseBuffer.getChannelData(0);
                for (let i=0;i<bufferSize;i++) output[i] = Math.random()*2 - 1;

                noiseSource = audioCtx.createBufferSource();
                noiseSource.buffer = noiseBuffer;
                noiseSource.loop = true;
                noiseSource.start();

                noiseGainNode = audioCtx.createGain();
                noiseGainNode.gain.value = 0;

                stereoPanner = audioCtx.createStereoPanner();

                noiseSource.connect(noiseGainNode);

                // Create enhanced cassette effect chain
                createCassetteEffectChain();

                // Load settings
                loadSettings();

                // Setup EQ slider listeners
                const frequenciesArr = [31,62,125,250,500,1000,2000,4000,8000,12000];
                eqSliders.forEach(slider => {
                    slider.addEventListener('input', () => {
                        if (!isPoweredOn) return;
                        const freq = parseFloat(slider.dataset.freq);
                        const index = frequenciesArr.indexOf(freq);
                        if (index !== -1 && eqFilters[index]) {
                            const value = parseFloat(slider.value);
                            if (Math.abs(value) < 1) slider.value = 0;
                            eqFilters[index].gain.value = parseFloat(slider.value);
                            saveSettings();
                        }
                    });
                });

                setupEffectButtons();
            } catch (err) {
                console.error('Error initializing audio context:', err);
                errorMessage.style.display = 'block';
                errorMessage.textContent = 'Failed to initialize audio context. Please try again.';
            }
        }

        // ============================================
        // Enhanced Effect Button Setup
        // ============================================
        function setupEffectButtons() {
            binatoneButton.addEventListener('click', () => {
                if (!isPoweredOn) return;
                const isOn = binatoneButton.classList.toggle('on');
                binatoneButton.textContent = `Crap Bass Boost: ${isOn ? 'ON' : 'OFF'}`;
                if (isOn) { 
                    lowpass.frequency.value = 3000; 
                    highpass.frequency.value = 300; 
                } else { 
                    lowpass.frequency.value = 20000; 
                    highpass.frequency.value = 20; 
                }
            });

            hyperbassButton.addEventListener('click', () => {
                if (!isPoweredOn) return;
                const isOn = hyperbassButton.classList.toggle('on');
                hyperbassButton.textContent = `Hyper Bass: ${isOn ? 'ON' : 'OFF'}`;
                if (bassBoost) {
                    bassBoost.gain.value = isOn ? 5 : 0;
                }
                saveSettings();
            });

            cassetteButton.addEventListener('click', () => {
                if (!isPoweredOn) return;
                const isOn = cassetteButton.classList.toggle('on');
                cassetteButton.textContent = `Cassette Mode: ${isOn ? 'ON' : 'OFF'}`;
                cassetteControls.style.display = isOn ? 'block' : 'none';
                
                if (isOn) {
                    applyCassetteQuality(cassetteQuality);
                    startEnhancedWowFlutter();
                    // Reconnect audio chain with cassette processing
                    if (source) connectAudioChain();
                } else {
                    stopEnhancedWowFlutter();
                    // Reset to normal frequencies
                    if (cassetteFilterLow) cassetteFilterLow.frequency.value = 20;
                    if (cassetteFilterHigh) cassetteFilterHigh.frequency.value = 20000;
                    if (noiseGainLow) noiseGainLow.gain.value = 0;
                    if (noiseGainMid) noiseGainMid.gain.value = 0;
                    if (compressionGain) compressionGain.gain.value = 1;
                    // Reconnect normal audio chain
                    if (source) {
                        try {
                            highpass.disconnect();
                            highpass.connect(stereoPanner);
                        } catch(e) {}
                    }
                }
            });

            stereoWideButton.addEventListener('click', () => {
                if (!isPoweredOn) return;
                const isOn = stereoWideButton.classList.toggle('on');
                stereoWideButton.textContent = `Stereo Wide: ${isOn ? 'ON' : 'OFF'}`;
                if (stereoPanner) stereoPanner.pan.value = isOn ? 0.8 : 0;
            });

            speedButton.addEventListener('click', () => {
                if (!isPoweredOn) return;
                currentSpeedIndex = (currentSpeedIndex + 1) % speeds.length;
                const speedSetting = speeds[currentSpeedIndex];
                speedButton.textContent = `Speed: ${speedSetting.label}`;
                if (audioElement && !cassetteButton.classList.contains('on')) {
                    audioElement.playbackRate = speedSetting.rate;
                }
            });

            loudnessButton.addEventListener('click', () => {
                if (!isPoweredOn) return;
                const isOn = loudnessButton.classList.toggle('on');
                loudnessButton.textContent = `Loudness: ${isOn ? 'ON' : 'OFF'}`;
                if (loudnessGainNode) {
                    loudnessGainNode.gain.value = isOn ? 1.2 : 1;
                }
                saveSettings();
            });

            // Cassette quality buttons
            document.querySelectorAll('.quality-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (!isPoweredOn) return;
                    cassetteQuality = btn.dataset.quality;
                    updateQualityButtons();
                    if (cassetteButton.classList.contains('on')) {
                        applyCassetteQuality(cassetteQuality);
                    }
                    saveSettings();
                });
            });

            loadCdButton.addEventListener('mousedown', () => { if (!isPoweredOn) return; loadCdButton.classList.add('on'); });
            loadCdButton.addEventListener('mouseup', () => { if (!isPoweredOn) return; loadCdButton.classList.remove('on'); });
        }
        
        // NEW WARP DRIVE FUNCTIONALITY
        function toggleWarpDrive() {
            if (!isPoweredOn || !audioElement) return;

            const isWarpOn = warpDriveButton.classList.toggle('on');
            warpDriveButton.textContent = `High Speed Dubbing: ${isWarpOn ? 'ON' : 'OFF'}`;
            
            clearInterval(speedRampInterval); // Clear any existing ramp
            
            audioElement.preservesPitch = !isWarpOn; // Turn off pitch preservation when warping
            
            const startRate = audioElement.playbackRate;
            const targetRate = isWarpOn ? 10.0 : speeds[currentSpeedIndex].rate;
            const duration = 2000; // 2 seconds
            const startTime = performance.now();
            
            function step(timestamp) {
                const elapsed = timestamp - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const currentRate = startRate + (targetRate - startRate) * progress;
                
                audioElement.playbackRate = currentRate;
                
                if (progress < 1) {
                    requestAnimationFrame(step);
                }
            }
            
            requestAnimationFrame(step);
        }

        warpDriveButton.addEventListener('click', toggleWarpDrive);
        // END NEW WARP DRIVE FUNCTIONALITY


        // ============================================
        // Audio Loading and Playback Functions
        // ============================================
        function loadAudio(file, index) {
            if (!isPoweredOn) {
                errorMessage.style.display = 'block';
                errorMessage.textContent = 'Please press the POWER button first.';
                return;
            }

            if (audioElement) {
                audioElement.pause();
                if (source) source.disconnect();
            }

            currentTrackIndex = index;
            audioElement = new Audio(URL.createObjectURL(file));
            audioElement.volume = volume / 100;
            trackInfo.textContent = file.name;
            audioElement.playbackRate = speeds[currentSpeedIndex].rate;

            audioElement.addEventListener('loadedmetadata', () => { 
                updateTrackTime(); 
                updatePlaylistUI(); 
            });

            audioElement.addEventListener('timeupdate', updateTrackTime);
            audioElement.addEventListener('ended', () => { playNextTrack(); });

            audioElement.addEventListener('canplay', () => {
                try {
                    source = audioCtx.createMediaElementSource(audioElement);
                } catch (e) {
                    console.error('createMediaElementSource failed:', e);
                    errorMessage.style.display = 'block';
                    errorMessage.textContent = 'Browser audio context error.';
                    return;
                }

                connectAudioChain();

                if (audioCtx.state === 'suspended') {
                    audioCtx.resume().then(() => {
                        audioElement.play().catch(err => {
                            console.error('Error playing audio:', err);
                            errorMessage.style.display = 'block';
                            errorMessage.textContent = 'Failed to play audio.';
                        });
                    });
                } else {
                    audioElement.play().catch(err => {
                        console.error('Error playing audio:', err);
                        errorMessage.style.display = 'block';
                        errorMessage.textContent = 'Failed to play audio.';
                    });
                }

                playButton.textContent = '⏸⏸ PAUSE';
            });

            audioElement.addEventListener('error', () => {
                errorMessage.style.display = 'block';
                errorMessage.textContent = 'Error loading audio file.';
            });
        }

        // ============================================
        // Track Time and Playlist Updates
        // ============================================
        function updateTrackTime() {
            if (!audioElement) return;
            const current = Math.floor(audioElement.currentTime);
            const duration = Math.floor(audioElement.duration) || 0;
            const currentMin = Math.floor(current / 60);
            const currentSec = current % 60;
            const durationMin = Math.floor(duration / 60);
            const durationSec = duration % 60;
            trackTime.textContent = `${currentMin}:${currentSec.toString().padStart(2,'0')} / ${durationMin}:${durationSec.toString().padStart(2,'0')}`;
        }

        function updatePlaylistUI() {
            playlistContainer.innerHTML = '';
            playlist.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'playlist-item';
                if (index === currentTrackIndex) item.classList.add('active');
                item.textContent = file.name;
                item.addEventListener('click', () => { if (!isPoweredOn) return; loadAudio(file, index); });
                playlistContainer.appendChild(item);
            });

            prevButton.disabled = !audioElement;
            nextButton.disabled = !audioElement;
        }

        // ============================================
        // Track Navigation Functions
        // ============================================
        function playNextTrack() {
            if (playlist.length > 1 && currentTrackIndex < playlist.length - 1) {
                loadAudio(playlist[currentTrackIndex + 1], currentTrackIndex + 1);
            } else {
                if (audioElement) audioElement.pause();
                playButton.textContent = '▶ PLAY';
                trackInfo.textContent = 'No track loaded';
                trackTime.textContent = '0:00 / 0:00';
                currentTrackIndex = -1;
                updatePlaylistUI();
            }
        }

        function playPreviousTrack() {
            if (playlist.length > 1 && currentTrackIndex > 0) {
                loadAudio(playlist[currentTrackIndex - 1], currentTrackIndex - 1);
            } else if (audioElement) {
                audioElement.currentTime = 0;
                updateTrackTime();
            }
        }

        function seekForward() { 
            if (audioElement) { 
                audioElement.currentTime = Math.min(audioElement.currentTime + 5, audioElement.duration); 
                updateTrackTime(); 
            } 
        }
        
        function seekBackward() { 
            if (audioElement) { 
                audioElement.currentTime = Math.max(audioElement.currentTime - 5, 0); 
                updateTrackTime(); 
            } 
        }

        // ============================================
        // File Input and Control Event Listeners
        // ============================================
        mp3Input.addEventListener('change', (event) => {
            const files = Array.from(event.target.files).filter(file => file.type === 'audio/mpeg');
            if (files.length === 0) {
                errorMessage.style.display = 'block';
                errorMessage.textContent = 'Please select valid MP3 files.';
                return;
            }
            playlist = files;
            currentTrackIndex = 0;
            loadAudio(playlist[0], 0);
            updatePlaylistUI();
        });

        playButton.addEventListener('click', () => {
            if (!isPoweredOn || !audioElement) return;
            if (audioElement.paused) {
                if (audioCtx.state === 'suspended') {
                    audioCtx.resume().catch(err => {
                        console.error('Error resuming AudioContext:', err);
                        errorMessage.style.display = 'block';
                        errorMessage.textContent = 'Please interact with the page to enable audio.';
                    });
                }
                audioElement.play().catch(err => {
                    console.error('Error playing audio:', err);
                    errorMessage.style.display = 'block';
                    errorMessage.textContent = 'Failed to play audio.';
                });
                playButton.textContent = '⏸⏸ PAUSE';
            } else {
                audioElement.pause();
                playButton.textContent = '▶ PLAY';
            }
        });

        // ============================================
        // Previous / Next Buttons (press-and-hold)
        // ============================================
        let timerFired = false;
        prevButton.addEventListener('mousedown', () => {
            if (!isPoweredOn || !audioElement) return;
            timerFired = false;
            pressTimer = setTimeout(() => { timerFired = true; seekInterval = setInterval(seekBackward, 200); }, 500);
        });

        prevButton.addEventListener('mouseup', () => {
            clearTimeout(pressTimer);
            clearInterval(seekInterval);
            if (!timerFired && playlist.length > 1) playPreviousTrack();
        });
        prevButton.addEventListener('mouseleave', () => { clearTimeout(pressTimer); clearInterval(seekInterval); });

        nextButton.addEventListener('mousedown', () => {
            if (!isPoweredOn || !audioElement) return;
            timerFired = false;
            pressTimer = setTimeout(() => { timerFired = true; seekInterval = setInterval(seekForward, 200); }, 500);
        });

        nextButton.addEventListener('mouseup', () => {
            clearTimeout(pressTimer);
            clearInterval(seekInterval);
            if (!timerFired && playlist.length > 1) playNextTrack();
        });
        nextButton.addEventListener('mouseleave', () => { clearTimeout(pressTimer); clearInterval(seekInterval); });

        // ============================================
        // Spectrum Analyzer Functions
        // ============================================
        function drawSpectrum(dataArray, bufferLength) {
            if (!isPoweredOn) {
                spectrumCtx.fillStyle = '#1e1e1e';
                spectrumCtx.fillRect(0,0,spectrumCanvas.width,spectrumCanvas.height);
                requestAnimationFrame(() => drawSpectrum(dataArray, bufferLength));
                return;
            }

            requestAnimationFrame(() => drawSpectrum(dataArray, bufferLength));

            if (analyser) {
                analyser.getByteFrequencyData(dataArray);
                spectrumCtx.fillStyle = '#1e1e1e';
                spectrumCtx.fillRect(0,0,spectrumCanvas.width,spectrumCanvas.height);

                const barWidth = (spectrumCanvas.width / bufferLength) * 2.5;
                let x = 0;
                for (let i=0;i<bufferLength;i++) {
                    const barHeight = dataArray[i] * (spectrumCanvas.height / 255);
                    const gradient = spectrumCtx.createLinearGradient(0, spectrumCanvas.height, 0, spectrumCanvas.height - barHeight);
                    gradient.addColorStop(0, '#00ff00');
                    gradient.addColorStop(0.5, '#ffff00');
                    gradient.addColorStop(1, '#ff0000');
                    spectrumCtx.fillStyle = gradient;
                    spectrumCtx.fillRect(x, spectrumCanvas.height - barHeight, barWidth, barHeight);
                    x += barWidth + 1;
                }
            }
        }

        // ============================================
        // Canvas Resize and Initialization
        // ============================================
        function resizeCanvas() {
            spectrumCanvas.width = spectrumCanvas.offsetWidth;
            spectrumCanvas.height = spectrumCanvas.offsetHeight;
            knobCanvas.width = 150;
            knobCanvas.height = 150;
            drawKnob();
        }

        window.addEventListener('resize', resizeCanvas);

        // ============================================
        // Initialization
        // ============================================
        resizeCanvas();
        hifiContainer.classList.add('off');
        loadSettings();

        // Kick off station checks once page loads
        window.addEventListener('load', () => {
            radioStation.innerHTML = '<option value="">Checking stations...</option>';
            checkStations().catch(err => {
                console.error('checkStations error:', err);
                radioStation.innerHTML = '<option value="">No stations available</option>';
            });
        });
    </script>
</body>
</html>
